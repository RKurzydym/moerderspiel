<div xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/"
      lang="en">
    <div id="inner-content">
	<div id="makeakill" class="box right half" py:if="game.status == 'RUNNING'">
		<h3>Erfolgreichen Mord melden!</h3>
		<p>Bevor du dies tust, vergewissere dich, dass dein Opfer bereits alle seine Morde eingetragen hat! (Frag einfach eben nach).</p>
		<p>Du solltest zu diesem Zeitpunkt bereits einen neuen
		Auftrag von deinem Opfer bekommen haben. Und zwar genau den
		Auftrag aus dem gleichen Kreis, in dem du dein Opfer gerade
		erledigt hast (siehe Auftragszettel).</p>
		<form action="killplayer" method="post" name="killplayer" onsubmit="return ajaxsubmit(this);" accept-charset="utf8">
			<input type="hidden" name="gameid" value="${game.id}"/>
			<table>
				<tr>
					<th>Signaturcode</th>
					<td><input type="text" name="victimid" size="8"/></td>
				</tr><tr>
					<th>Mörder</th>
					<td>
						<select name="killerpublicid">
							<py:for each="player in sorted(game.players, key=lambda p: p.name + p.info)">
								<option	value="${player.public_id}">${player}</option>
							</py:for>
						</select>
					</td>
				</tr><tr>
					<th>Datum</th>
					<td>
						<input id="killdate" type="text" name="datum" value="${utils.now()}"/><button id="f_trigger_b">...</button>
					</td>
				</tr><tr>
					<th>Tathergang</th>
					<td><input type="text" name="reason" size="40"/></td>
				</tr><tr>
					<th>&nbsp;</th>
					<td><input type="submit" value="Auftrag erledigt!"/></td>
				</tr>
			</table>
		</form>
		<script type="text/javascript">
		if( calbox ) {
			calbox.destroy()
		}
		var calbox = Calendar.setup({
				inputField     :    "killdate",      // id of the input field
				ifFormat       :    "%d.%m.%Y %H:%M",       // format of the input field
				showsTime      :    true,            // will display a time selector
				timeFormat     :    24,
				button         :    "f_trigger_b",   // trigger for the calendar (button ID)
				singleClick    :    false,           // double-click mode
				firstDay       :    1,
				step           :    1                // show all years in drop-down boxes (instead of every other year as default)
			});
		</script>
	</div>
	<div id="gameinfo" class="left half">
		<h2>Spiel: ${game.name}</h2>
		<dl>
			<dt>Status</dt><dd>${game.status}</dd>
			<dt>ID</dt><dd>${game.id}</dd>
			<py:if test="len(game.rounds) > 1"><dt>Kreise</dt><dd>${len(game.rounds)}</dd></py:if>
			<dt>Spieler</dt><dd>${len(game.players)}</dd>
			<dt>Morde</dt><dd>${len(list(game.getKilled()))}</dd>
			<py:if test="game.status != 'OPEN'"><dt>Massenmörder</dt><dd>${game.getMassMurdererString()}</dd></py:if>
		</dl>
	</div>
	<div id="goadmin" class="box right half clear">
		<form action="admin" method="post" accept-charset="utf8">
			<input type="hidden" name="id" value="${game.id}"/>
			<table>
				<tr>
					<th>Game Master Code:</th>
					<td><input type="password" name="mastercode" size="7"/></td>
					<td><input type="submit" value="Go Game Master!"/></td>
				</tr>
			</table>
		</form>
	</div>
	<div id="gamestart" class="box right half clear" py:if="game.status == 'OPEN'">
		<h3>Spiel starten</h3>
		<p>Dies beendet die Registrierungsphase, generiert die Aufträge und startet das Spiel. Danach können keine weiteren Mitspieler einsteigen.</p>
		<form action="startgame" method="post" accept-charset="utf8" onsubmit="showloadinganimation(this); this.style.display='none';">
			<input type="hidden" name="gameid" value="${game.id}"/>
			<table>
				<tr>
					<th>Game Master Code:</th>
					<td><input type="password" name="mastercode" size="7"/></td>
					<td><input type="submit" value="Spiel starten!"/></td>
				</tr>
			</table>
		</form>
		<p>Die Generierung der PDFs kann mehrere Minuten dauern. Bitte habe Geduld!</p>
	</div>
	<div id="rules" class="box right half clear">
		<h3><a href="../documents/moerderspielregeln.pdf">Regeln</a> (PDF)</h3>
	</div>
	<div id="addplayer" class="box right half clear" py:if="game.status == 'OPEN'">
		<h3>Spieler anmelden</h3>
		<form action="addplayer" method="post" onsubmit="ajaxsubmit(this); return false;" accept-charset="utf8">
			<input type="hidden" name="gameid" value="${game.id}"/>
			<table>
				<tr>
					<th>Name:</th>
					<td><input type="text" name="spielername" size="20"/></td>
				</tr>
				<tr>
					<th>Hochschule:</th>
					<td><input type="text" name="zusatzinfo" size="20"/></td>
				</tr>
				<tr>
					<th>Email-Adresse:</th>
					<td><input type="text" name="email" size="20"/></td>
				</tr>
				<tr>
					<th></th>
					<td><input type="submit" value="Spieler eintragen!"/></td>
				</tr>
			</table>
		</form>
	</div>
	<div id="listplayers">
		<py:if test="game.status == 'OPEN'">
			<h3>Liste der Mitspieler</h3>
			<table>
				<tr>
					<th>Name</th>
					<th>Hochschule</th>
				</tr>
				<py:for each="player in game.players">
					<tr><td>${player.name}</td><td>${player.info}</td></tr>
				</py:for>
			</table>
		</py:if>
		<py:if test="game.status == 'RUNNING'">
			<h3>Morde</h3>
			<table>
				<tr><th>Name</th><th>Ermordet von</th><th py:if="len(game.rounds) > 1">Kreis</th><th>Wann?</th><th>Tathergang</th></tr>
				<py:for each="p in sorted(game.getKilled(), key=lambda r: r.killedby.date, reverse=True)">
						<tr py:if="p.killedby and p.killedby.killer">
							<td>${p.player} <span class="deaths" style="width:${game.getDeathsCount(p)*9}px;">&nbsp;</span></td>
							<td><py:if test="p.killedby and p.killedby.killer">${p.killedby.killer.player} <span class="kills" style="width:${game.getKillsCount(p.killedby.killer.player)*9}px;">&nbsp;</span></py:if><py:if test="p.killedby and not p.killedby.killer">Game Master</py:if></td>
							<td py:if="len(game.rounds) > 1"><py:if test="p.killedby">${p.round.name}</py:if></td>
							<td><py:if test="p.killedby">${p.killedby.date}</py:if></td>
							<td><py:if test="p.killedby">${p.killedby.reason}</py:if></td>
						</tr>
				</py:for>
			</table>
		</py:if>
		<py:for each="round in sorted(game.rounds)" py:if="game.status == 'RUNNING' or game.status == 'OVER'">
			<div class="box collapsed full white" py:if="len(game.rounds) > 1">
				<h3 py:if="len(game.rounds) > 1">Kreis: ${round}</h3>
				<table py:if="game.status == 'RUNNING'">
					<tr><th>Name</th><th>Ermordet von</th><th>Wann?</th><th>Tathergang</th></tr>
					<py:for each="p in game.rounds[round].getDeadParticipants()">
						<tr>
							<td>${p.player}</td>
							<td><py:if test="p.killedby and p.killedby.killer">${p.killedby.killer.player}</py:if><py:if test="p.killedby and not p.killedby.killer">Game Master</py:if></td>
							<td><py:if test="p.killedby">${p.killedby.date}</py:if></td>
							<td><py:if test="p.killedby">${p.killedby.reason}</py:if></td>
						</tr>
					</py:for>
	<!--
					<py:for each="p in game.rounds[round].getLivingParticipants()">
						<tr>
							<td>${p.player.html()}</td>
							<td></td>
							<td></td>
							<td></td>
						</tr>
					</py:for>
	-->
				</table>
			</div>
			<table py:if="game.status == 'OVER'">
				<tr><th>Name</th><th>Ermordet von</th><th>Wann?</th><th>Tathergang</th></tr>
				<py:for each="p in game.rounds[round].participants">
					<tr>
						<td>${p.player}</td>
						<td><py:if test="p.killedby and p.killedby.killer">${p.killedby.killer.player}</py:if><py:if test="p.killedby and not p.killedby.killer">Game Master</py:if></td>
						<td><py:if test="p.killedby">${p.killedby.date}</py:if></td>
						<td><py:if test="p.killedby">${p.killedby.reason}</py:if></td>
					</tr>
				</py:for>
			</table>

			<div style="width:100%; height:50em; overflow:auto; border:1px solid black; text-align:center;">
				<img src="gamegraph?id=${game.id}&amp;roundid=${round}" />
			</div>
		</py:for>
	</div>
	</div>
</div>
